// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "../../contracts/Comet.sol";
import "../../contracts/CometConfiguration.sol";
import "../../contracts/liquidator/LiquidatorV2.sol";
// import "../CometInterface.sol";

interface WBTC {
    function owner() external returns (address);
    function mint(address _to, uint256 _amount) external returns (bool);
}

// https://ethereum.stackexchange.com/questions/39989/solidity-convert-hex-string-to-bytes
// Convert an hexadecimal character to their value
function fromHexChar(uint8 c) pure returns (uint8) {
    if (bytes1(c) >= bytes1('0') && bytes1(c) <= bytes1('9')) {
        return c - uint8(bytes1('0'));
    }
    if (bytes1(c) >= bytes1('a') && bytes1(c) <= bytes1('f')) {
        return 10 + c - uint8(bytes1('a'));
    }
    if (bytes1(c) >= bytes1('A') && bytes1(c) <= bytes1('F')) {
        return 10 + c - uint8(bytes1('A'));
    }
    revert("fromHexChar fail");
}

// Convert an hexadecimal string to raw bytes
function fromHex(string memory s) pure returns (bytes memory) {
    bytes memory ss = bytes(s);
    require(ss.length%2 == 0); // length must be even
    bytes memory r = new bytes(ss.length/2);
    for (uint i=0; i<ss.length/2; ++i) {
        r[i] = bytes1(fromHexChar(uint8(ss[2*i])) * 16 +
                    fromHexChar(uint8(ss[2*i+1])));
    }
    return r;
}

contract LiquidationBotV2Test is Test {
    // Comet public comet;
    LiquidatorV2 public liquidator;
    address[] public assets;
    uint256[] public assetBaseAmounts;
    address[] public swapTargets;
    bytes[] public swapTransactions;

    function setUp() public {
        liquidator = new LiquidatorV2(
            CometInterface(0xc3d688B66703497DAA19211EEdff47f25384cdc3), // comet
            address(0x1F98431c8aD98523631AE4a59f267346ea31F984), // uniswap v3 factory
            address(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2), // weth9
            address(0x5a13D329A193ca3B1fE2d7B459097EdDba14C28F) // recipient
        );

        assets.push(0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599);
        assetBaseAmounts.push(2006587791656);
        swapTargets.push(0x1111111254EEB25477B68fb85Ed929f73A960582);

        bytes memory tx = fromHex("12aa3caf00000000000000000000000053222470cdcfb8081c0e3a50fd106f0d69e63f200000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000053222470cdcfb8081c0e3a50fd106f0d69e63f20000000000000000000000000ce71065d4017f316ec606fe4422e11eb2c47c24600000000000000000000000000000000000000000000000000000002c41a6a00000000000000000000000000000000000000000000000000000001cdecb39aed000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ff0000000000000000000000000000000000000008e10008b300086900084f00a0c9e75c480000000000000000070300000000000000000000000000000000000000000000000000082100038700a0c9e75c4800000000000000220f010000000000000000000000000000000000000000000003590000ff0000b051002109f78b46a789125598f5ad2b7f243751c2934d2260fac5e5542a773aa44fbcfedf7c193bc2c59900048dae7333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c4cdfcfe0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000029872a4f57ee63c1e50199ac8ca7087fa4a2a1fb6357269965a2014abc352260fac5e5542a773aa44fbcfedf7c193bc2c59900a007e5c0d20000000000000000000000000000000000000002360001860000ca0000b051207fc77b5c7614e1533320ea6ddc2eb61fa00a97142260fac5e5542a773aa44fbcfedf7c193bc2c59900443df0212400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010020d6bdbf78fe18be6b3bd88a2d2a7f928d00292e7a9963cfc64120c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f002444b3e92373425443000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000735553440000000000000000000000000000000000000000000000000000000031494e434800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005120a5407eae9ba41422680e2e00537571bcc53efbfd57ab1ec28d129707052df4df418d58a2d46d5f5100443df02124000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100a007e5c0d20000000000000000000000000000000000000000000000000004760001e000a0c9e75c480000000000002308ff070000000000000000000000000000000000000001b20001630001140000fa00a007e5c0d20000000000000000000000000000000000000000000000000000d60000d05100d51a44d3fae010294c616388b506acda1bfaae462260fac5e5542a773aa44fbcfedf7c193bc2c5990044394747c5000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008339de3768fab529a000000000000000000000000000000000000000000000000000000000000000100206b4be0b94041c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2d0e30db002a00000000000000000000000000000000000000000000000095a6d03e00cdde91fee63c1e501cbcdf9626bc03e24f779434178a73a0b4bad62ed2260fac5e5542a773aa44fbcfedf7c193bc2c59902a000000000000000000000000000000000000000000000002902e4c8eff3bbb60aee63c1e5014585fe77225b41b697c938b018e2ac67ac5a20c02260fac5e5542a773aa44fbcfedf7c193bc2c59900a0c9e75c4800000000000000001f1300000000000000000000000000000000000000000000000000026800021900a0860a32ec000000000000000000000000000000000000000000000016b59668ec5749c1020001f051001111111254fb6c44bac0bed2854e76f90643097dc02aaa39b223fe8d0a0e5c4f27ead9083c756cc20124d0a3b665000000000000000000000000000000000000000063882b8a00000184cbe83dff000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000945bcf562085de2d5875b9e2012ed5fd5cfab92700000000000000000000000053222470cdcfb8081c0e3a50fd106f0d69e63f200000000000000000000000000000000000000000000000000000007d4c6cfdf1000000000000000000000000000000000000000000000016b59668ec5749c102000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004180bf0ce3be6172ffd16f7cebd5055819120b8e8b415e954f5e446da73f6c397423e22970a55e890cd14387e352c899200885ab921dd499d93e4462213f10fc5f1c0000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000c8a83cdc43ee63c1e50088e6a0c2ddd26feeb64f039a2c41296fcb3f5640c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20020d6bdbf78a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800a0f2fa6b66a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000001d75a05a350000000000000000000000000004c474b80a06c4eca27a0b86991c6218b36c1d19d4a2e9eb0ce3606eb481111111254eeb25477b68fb85ed929f73a96058200cfee7c08");
        swapTransactions.push(tx);
    }

    // function testOne() public {
    //     uint256 a = 41;
    //     uint256 b = 42;
    //     assertEq(a, b);
    // }

    function testTwo() public {
        address wbtc = 0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599;
        address wbtcOwner = WBTC(wbtc).owner();

        vm.prank(wbtcOwner);
        WBTC(wbtc).mint(
            0xc3d688B66703497DAA19211EEdff47f25384cdc3, // XXX comet
            120e8
        );

        vm.label(0x1111111254EEB25477B68fb85Ed929f73A960582, "AggregationRouterV5");
        vm.label(wbtc, "WBTC");

        address[] memory liquidatableAccounts;

        (
            address[] memory returnedAssets,
            uint256[] memory returnedCollateralReserves,
            uint256[] memory returnedCollateralReservesInBase
        ) = liquidator.availableCollateral(liquidatableAccounts);

        for (uint8 i = 0; i < returnedAssets.length; i++) {
            console.log("returnedAssets: %s", i);
            console.log(returnedAssets[i]);
            console.log(returnedCollateralReserves[i]);
            console.log(returnedCollateralReservesInBase[i]);
            console.log("done returnedAssets: %s", i);
        }

        liquidator.absorbAndArbitrage(
            liquidatableAccounts, // liquidatableAccounts,
            assets, // assets,
            assetBaseAmounts, // assetBaseAmounts,
            swapTargets, // swapTargets,
            swapTransactions // swapTransactions
        );
    }

}
